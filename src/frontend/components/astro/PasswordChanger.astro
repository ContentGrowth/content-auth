---
export interface Props {
    baseUrl?: string;
    className?: string;
}

const { baseUrl, className = '' } = Astro.props;
---

<form class={`ca-form ${className}`} data-password-changer data-base-url={baseUrl}>
    <div class="ca-input-group">
        <label class="ca-label" for="current-password">Current Password</label>
        <input
            id="current-password"
            type="password"
            class="ca-input"
            name="currentPassword"
            required
        />
    </div>

    <div class="ca-input-group">
        <label class="ca-label" for="new-password">New Password</label>
        <input
            id="new-password"
            type="password"
            class="ca-input"
            name="newPassword"
            minlength={8}
            required
        />
    </div>

    <div class="ca-input-group">
        <label class="ca-label" for="confirm-password">Confirm New Password</label>
        <input
            id="confirm-password"
            type="password"
            class="ca-input"
            name="confirmPassword"
            minlength={8}
            required
        />
    </div>

    <div class="ca-error" data-error-message style="display: none;"></div>
    <div class="ca-success-message" data-success-message style="display: none; padding: 0.75rem; background: #d1fae5; border-radius: 6px; color: #065f46; text-align: center;">
        Password updated successfully!
    </div>

    <button type="submit" class="ca-button" data-submit-button>
        Update Password
    </button>
</form>

<script>
import { createClient } from '../../clients/astro-client';

document.querySelectorAll('[data-password-changer]').forEach((form) => {
    const baseUrl = form.getAttribute('data-base-url') || undefined;
    const client = createClient(baseUrl);
    
    const submitBtn = form.querySelector('[data-submit-button]') as HTMLButtonElement;
    const errorDiv = form.querySelector('[data-error-message]') as HTMLDivElement;
    const successDiv = form.querySelector('[data-success-message]') as HTMLDivElement;

    const showError = (message: string) => {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
    };

    const showSuccess = () => {
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
    };

    const hideMessages = () => {
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
    };

    const setLoading = (loading: boolean) => {
        submitBtn.disabled = loading;
        submitBtn.textContent = loading ? 'Updating...' : 'Update Password';
    };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessages();
        
        const formData = new FormData(form as HTMLFormElement);
        const currentPassword = formData.get('currentPassword') as string;
        const newPassword = formData.get('newPassword') as string;
        const confirmPassword = formData.get('confirmPassword') as string;

        if (newPassword !== confirmPassword) {
            showError("New passwords don't match");
            return;
        }

        setLoading(true);

        try {
            const res = await client.changePassword({
                currentPassword,
                newPassword
            });

            if (res?.error) {
                throw new Error(res.error.message);
            }

            // Clear form on success
            (form as HTMLFormElement).reset();
            showSuccess();
        } catch (err: any) {
            if (err?.code === 'CREDENTIAL_ACCOUNT_NOT_FOUND' || err?.message?.includes('Credential account not found')) {
                showError("You are logged in via a social provider (e.g. GitHub, Google) and do not have a password set.");
            } else {
                showError(err.message || 'Failed to change password');
            }
        } finally {
            setLoading(false);
        }
    });
});
</script>
